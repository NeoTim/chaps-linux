From 9223d18dfedad160ad4648ad088da40375a8c69e Mon Sep 17 00:00:00 2001
From: David Drysdale <drysdale@google.com>
Date: Thu, 2 Oct 2014 11:57:19 +0100
Subject: [PATCH 2/9] chaps: Check for D-Bus acquire_name() method

DBus::Connection::acquire_name() does not exist in the upstream version
of libdbus-c++, so check for it and stick to the original request_name()
method if not present.

BUG=None
TEST=Chaps unit tests (with ASAN) plus PKCS11 tests

Change-Id: If2b2dd875d6a3f109331306035a0b1db20856213
---
 chaps/Makefile         | 6 ++++++
 chaps/chaps_adaptor.cc | 4 ++++
 2 files changed, 10 insertions(+)

diff --git a/chaps/Makefile b/chaps/Makefile
index e9d024ec8eb8..7f6ebbbbc2e1 100644
--- a/chaps/Makefile
+++ b/chaps/Makefile
@@ -130,6 +130,12 @@ DBUS_POLICY = "context=\"default\""
 else
 DBUS_POLICY = "group=\"pkcs11\""
 endif
+DBUS_FLAGS := $(call check_compile_cxx, \
+	'\#include <dbus-c++/dbus.h>\nint main(){\
+	DBus::Connection::SystemBus().acquire_name("dummy");\
+	return 0;}',,-DNO_DBUS_ACQUIRE_NAME)
+CXXFLAGS += $(DBUS_FLAGS)
+
 .PHONY: $(OUT)/org.chromium.Chaps.conf
 $(OUT)/org.chromium.Chaps.conf :
 	sed -e "s/@POLICY_PERMISSIONS@/$(DBUS_POLICY)/" \
diff --git a/chaps/chaps_adaptor.cc b/chaps/chaps_adaptor.cc
index 3e02d24fceb8..7f3eb2baedac 100644
--- a/chaps/chaps_adaptor.cc
+++ b/chaps/chaps_adaptor.cc
@@ -25,7 +25,11 @@ namespace chaps {
 // Helper used when calling the ObjectAdaptor constructor.
 static DBus::Connection& GetConnection() {
   static DBus::Connection connection = DBus::Connection::SystemBus();
+#ifdef NO_DBUS_ACQUIRE_NAME
+  connection.request_name(kChapsServiceName);
+#else
   CHECK(connection.acquire_name(kChapsServiceName));
+#endif
   return connection;
 }
 
-- 
2.1.0.rc2.206.gedb03e5

